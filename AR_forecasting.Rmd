---
title: "AR_forecasting"
author: "Krystal"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
library(tidyverse)
library(stringr)
library(forecast)
library(ggplot2)
```

### Load in PV Data with Day Type Dummy - WEEKEND/HOLIDAY or WEEKDAY
```{r}
# Passenger Volume for Buses - By Bus Stops (2023 Dec)
pv_bus_202312 <- read.csv("../PV Data [Buses and Trains]/Buses/By Bus Stop/transport_node_bus_202312.csv") %>%
  mutate(seasonal_dummy = ifelse(DAY_TYPE == "WEEKENDS/HOLIDAY", 1, 
                                 ifelse(DAY_TYPE == "WEEKDAY", 0, NA)))

# Passenger Volume for Buses - By Bus Stops (2024 Jan)
pv_bus_202401 <- read.csv("../PV Data [Buses and Trains]/Buses/By Bus Stop/transport_node_bus_202401.csv") %>%
  mutate(seasonal_dummy = ifelse(DAY_TYPE == "WEEKENDS/HOLIDAY", 1, 
                                 ifelse(DAY_TYPE == "WEEKDAY", 0, NA)))

# Passenger Volume for Buses - By Bus Stops (2024 Feb)
pv_bus_202402 <- read.csv("../PV Data [Buses and Trains]/Buses/By Bus Stop/transport_node_bus_202402.csv") %>%
  mutate(seasonal_dummy = ifelse(DAY_TYPE == "WEEKENDS/HOLIDAY", 1, 
                                 ifelse(DAY_TYPE == "WEEKDAY", 0, NA)))

# Passenger Volume for Buses - By Origin Destination Bus Stops (2023 Dec)
pv_bus_od_202312 <- read.csv("../PV Data [Buses and Trains]/Buses/By OD/origin_destination_bus_202312.csv") %>%
  mutate(seasonal_dummy = ifelse(DAY_TYPE == "WEEKENDS/HOLIDAY", 1, 
                                 ifelse(DAY_TYPE == "WEEKDAY", 0, NA)))

# Passenger Volume for Buses - By Origin Destination Bus Stops (2024 Jan)
pv_bus_od_202401 <- read.csv("../PV Data [Buses and Trains]/Buses/By OD/origin_destination_bus_202401.csv") %>%
  mutate(seasonal_dummy = ifelse(DAY_TYPE == "WEEKENDS/HOLIDAY", 1, 
                                 ifelse(DAY_TYPE == "WEEKDAY", 0, NA)))

# Passenger Volume for Buses - By Origin Destination Bus Stops (2024 Feb)
pv_bus_od_202402 <- read.csv("../PV Data [Buses and Trains]/Buses/By OD/origin_destination_bus_202402.csv") %>%
  mutate(seasonal_dummy = ifelse(DAY_TYPE == "WEEKENDS/HOLIDAY", 1, 
                                 ifelse(DAY_TYPE == "WEEKDAY", 0, NA)))

# Passenger Volume for Trains - By Train Stops (2023 Dec)
pv_train_202312 <- read.csv("../PV Data [Buses and Trains]/Trains/By Train Station/transport_node_train_202312.csv") %>%
  mutate(seasonal_dummy = ifelse(DAY_TYPE == "WEEKENDS/HOLIDAY", 1, 
                                 ifelse(DAY_TYPE == "WEEKDAY", 0, NA)))


# Passenger Volume for Trains - By Train Stops (2024 Jan)
pv_train_202401 <- read.csv("../PV Data [Buses and Trains]/Trains/By Train Station/transport_node_train_202401.csv") %>%
  mutate(seasonal_dummy = ifelse(DAY_TYPE == "WEEKENDS/HOLIDAY", 1, 
                                 ifelse(DAY_TYPE == "WEEKDAY", 0, NA)))

# Passenger Volume for Trains - By Train Stops (2024 Feb)
pv_train_202402 <- read.csv("../PV Data [Buses and Trains]/Trains/By Train Station/transport_node_train_202402.csv") %>%
  mutate(seasonal_dummy = ifelse(DAY_TYPE == "WEEKENDS/HOLIDAY", 1, 
                                 ifelse(DAY_TYPE == "WEEKDAY", 0, NA)))

# Passenger Volume for Trains - By Origin Destination (2023 Dec)
pv_train_od_202312 <- read.csv("../PV Data [Buses and Trains]/Trains/By OD/origin_destination_train_202312.csv") %>%
  mutate(seasonal_dummy = ifelse(DAY_TYPE == "WEEKENDS/HOLIDAY", 1, 
                                 ifelse(DAY_TYPE == "WEEKDAY", 0, NA)))

# Passenger Volume for Trains - By Origin Destination (2024 Jan)
pv_train_od_202401 <- read.csv("../PV Data [Buses and Trains]/Trains/By OD/origin_destination_train_202401.csv") %>%
  mutate(seasonal_dummy = ifelse(DAY_TYPE == "WEEKENDS/HOLIDAY", 1, 
                                 ifelse(DAY_TYPE == "WEEKDAY", 0, NA)))

# Passenger Volume for Trains - By Origin Destination (2024 Feb)
pv_train_od_202402 <- read.csv("../PV Data [Buses and Trains]/Trains/By OD/origin_destination_train_202402.csv") %>%
  mutate(seasonal_dummy = ifelse(DAY_TYPE == "WEEKENDS/HOLIDAY", 1, 
                                 ifelse(DAY_TYPE == "WEEKDAY", 0, NA)))
```

```{r}
# Merge all Train By OD Passenger Volume data for Dec 2023 and Jan 2024 
combined_train_pv_od <- rbind(pv_train_od_202312, pv_train_od_202401) %>%
  mutate(trip = str_c(ORIGIN_PT_CODE, DESTINATION_PT_CODE, sep="-")) %>%
  mutate(trip = as.factor(trip)) %>%
  mutate(seasonal_dummy = as.factor(seasonal_dummy)) %>%
  mutate(ORIGIN_PT_CODE = as.factor(ORIGIN_PT_CODE)) %>%
  mutate(DESTINATION_PT_CODE = as.factor(DESTINATION_PT_CODE)) %>%
  mutate(YEAR_MONTH = as.Date(paste(YEAR_MONTH,"01",sep = "-")))
  
combined_train_pv_od$YEAR_MONTH_HOUR = combined_train_pv_od$YEAR_MONTH
combined_train_pv_od$YEAR_MONTH_HOUR = as.POSIXct(paste(combined_train_pv_od$YEAR_MONTH_HOUR, combined_train_pv_od$TIME_PER_HOUR), format = "%Y-%m-%d %H") 
combined_train_pv_od$Year <- as.integer(format(combined_train_pv_od$YEAR_MONTH_HOUR, "%Y"))
combined_train_pv_od$Month <- as.integer(format(combined_train_pv_od$YEAR_MONTH_HOUR, "%m"))
combined_train_pv_od$Hour <- as.integer(format(combined_train_pv_od$YEAR_MONTH_HOUR, "%H"))
combined_train_pv_od$trip_numeric <- as.numeric(as.factor(combined_train_pv_od$trip))

str(combined_train_pv_od)


### Testing Data > Feb 2024
pv_train_od_202402 <- pv_train_od_202402 %>%
  mutate(trip = str_c(ORIGIN_PT_CODE, DESTINATION_PT_CODE, sep="-")) %>%
  mutate(trip = as.factor(trip)) %>%
  mutate(seasonal_dummy = as.factor(seasonal_dummy)) %>%
  mutate(ORIGIN_PT_CODE = as.factor(ORIGIN_PT_CODE)) %>%
  mutate(DESTINATION_PT_CODE = as.factor(DESTINATION_PT_CODE)) %>%
  mutate(YEAR_MONTH = as.Date(paste(YEAR_MONTH,"01",sep = "-")))
  
pv_train_od_202402$YEAR_MONTH_HOUR = pv_train_od_202402$YEAR_MONTH
pv_train_od_202402$YEAR_MONTH_HOUR = as.POSIXct(paste(pv_train_od_202402$YEAR_MONTH_HOUR, pv_train_od_202402$TIME_PER_HOUR), format = "%Y-%m-%d %H") 
pv_train_od_202402$Year <- as.integer(format(pv_train_od_202402$YEAR_MONTH_HOUR, "%Y"))
pv_train_od_202402$Month <- as.integer(format(pv_train_od_202402$YEAR_MONTH_HOUR, "%m"))
pv_train_od_202402$Hour <- as.integer(format(pv_train_od_202402$YEAR_MONTH_HOUR, "%H"))
pv_train_od_202402$trip_numeric <- as.numeric(as.factor(pv_train_od_202402$trip))
```


```{r}
data <- combined_train_pv_od$TOTAL_TRIPS

X <- data.frame(
  Year = as.numeric(combined_train_pv_od$Year),
  Month = as.integer(combined_train_pv_od$Month),
  Hour = as.integer(combined_train_pv_od$Hour),
  seasonal_dummy = as.integer(combined_train_pv_od$seasonal_dummy),
  trip_numeric = as.numeric(combined_train_pv_od$trip_numeric)
)

str(X)

X_matrix <- as.matrix(X[, c("Year", "Month", "Hour", "seasonal_dummy", "trip_numeric")])

ar_model <- auto.arima(data, xreg = X_matrix)

summary(ar_model)

test_data <- data.frame(
  Year = as.numeric(pv_train_od_202402$Year),
  Month = as.integer(pv_train_od_202402$Month),
  Hour = as.integer(pv_train_od_202402$Hour),
  seasonal_dummy = as.integer(pv_train_od_202402$seasonal_dummy),
  trip_numeric = as.numeric(pv_train_od_202402$trip_numeric)
)

X_matrix_test <- as.matrix(test_data[, c("Year", "Month", "Hour", "seasonal_dummy", "trip_numeric")])

forecast_result <- forecast(ar_model, xreg = X_matrix_test)

forecasted_values <- forecast_result$mean
```

```{r}
actual_data <- pv_train_od_202402$TOTAL_TRIPS

forecasted_values <- forecast_result$mean

mae <- mean(abs(forecasted_values - actual_data))

rmse <- sqrt(mean((forecasted_values - actual_data)^2))

# compare forecasts with actual TOTAL_TRIPS
comparison_df <- data.frame(
  Actual = actual_data,
  Forecasted = forecasted_values
)
```


```{r}
fit_arima <- function(data, order, xreg) {
  ar_model <- Arima(data, order = c(order, 0, 0), xreg = X_matrix)
  return(AIC(ar_model))
}

data <- combined_train_pv_od$TOTAL_TRIPS

lags <- 10:15  # current best lag of 10

aic_values <- numeric(length(lags))

# fit diff lags to model
for (i in seq_along(lags)) {
  aic_values[i] <- fit_arima(data, lags[i], X_matrix)
}

best_lag <- lags[which.min(aic_values)]

# order parameter specifies order(number of lags, order of difference, number of moving average components) - set to 0 for standard AR >> change accordingly 

ar_model <- Arima(data, order = c(best_lag, 0, 0), xreg = X_matrix)
summary(ar_model)

forecast_result <- forecast(ar_model)

print(forecast_result)




# Define a range of lags to explore
lags <- 15:20

# Initialize a vector to store AIC values
aic_values <- numeric(length(lags))

# Fit ARIMA models with different lags
for (i in lags) {
  tryCatch({
    arima_model <- Arima(data, order = c(i, 0, 0), xreg = X_matrix)
    aic_values[i] <- AIC(arima_model)
  }, error = function(e) {
    # Handle any errors during model fitting
    aic_values[i] <- Inf  # Assign a large value to skip problematic models
  })
}

# Identify the lag with the lowest AIC
best_lag <- lags[which.min(aic_values)]

# Fit the final ARIMA model with the chosen lag
final_arima_model <- Arima(data, order = c(best_lag, 0, 0), xreg = X_matrix)

# Forecast using the test data
forecast_result <- forecast(final_arima_model, xreg = X_matrix_test)
forecasted_values <- forecast_result$mean

```
